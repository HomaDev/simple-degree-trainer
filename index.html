<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Degrees Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            background-color: #0a0a0a;
            color: #e5e5e5;
            font-family: 'JetBrains Mono', monospace;
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Compact Range Sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 12px; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #ff9e0b;
            cursor: pointer;
            margin-top: -5px;
            border: 1px solid #0a0a0a;
            position: relative;
            z-index: 10;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }
        
        /* Number inputs */
        input[type=number] {
            background: #161616;
            border: 1px solid #333;
            color: #ff9e0b;
            padding: 0 4px;
            border-radius: 2px;
            width: 50px;
            font-size: 0.7rem;
            height: 20px;
        }
        input[type=number]:focus { outline: none; border-color: #ff9e0b; }

        /* Selects */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ff9e0b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1em 1em;
            padding-right: 1.5rem;
            -webkit-appearance: none;
            appearance: none;
            font-size: 0.75rem;
            height: 24px;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* Dual Slider container */
        .range-slider-container {
            position: relative;
            width: 100%;
            height: 20px;
            text-align: center;
        }
        .range-slider-container input[type=range] {
            position: absolute;
            left: 0;
            bottom: 0;
            pointer-events: none;
        }
        .range-slider-container input[type=range]::-webkit-slider-thumb { pointer-events: all; }
        .range-slider-container input[type=range]::-moz-range-thumb { pointer-events: all; }

        /* Square Keys */
        .degree-sq {
            width: 36px;
            height: 36px;
            border: 1px solid #333;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.15s;
            background: #1a1a1a;
            margin: 2px;
        }
        .degree-sq:hover { background: #252525; }
        .degree-sq.active {
            background-color: #ff9e0b;
            color: black;
            border-color: #ff9e0b;
            box-shadow: 0 0 6px rgba(255, 158, 11, 0.3);
        }
        .degree-sq .main-lbl { font-weight: bold; font-size: 0.7rem; line-height: 1; }
        .degree-sq .sub-lbl { font-size: 0.4rem; opacity: 0.6; text-transform: uppercase; margin-top: 1px; }

        .control-group {
            background: #121212;
            border: 1px solid #262626;
            padding: 0.75rem;
            border-radius: 4px;
        }
        
        label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; }

        /* Loading Bar */
        #loader-container {
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div class="w-full max-w-2xl flex flex-col gap-3">
        
        <header class="flex justify-between items-baseline border-b border-zinc-800 pb-2">
            <div>
                <h1 class="text-xl font-bold text-white tracking-tighter leading-none">REAL<span class="text-amber-500">PIANO</span></h1>
            </div>
            <div id="status-display" class="text-amber-500 text-xs font-bold opacity-0 transition-opacity">‚óè LIVE</div>
        </header>

        <div id="loader-container" class="w-full bg-zinc-900 rounded-full h-1.5 mb-2 relative overflow-hidden hidden">
            <div id="loader-bar" class="bg-amber-500 h-1.5 absolute left-0 top-0 w-0 transition-all duration-300"></div>
        </div>
        <div id="loader-text" class="text-center text-[10px] text-zinc-500 h-4 hidden">Downloading Piano Samples...</div>

        <div class="grid grid-cols-2 gap-3">
            
            <div class="control-group flex flex-col gap-3">
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block mb-1">Root Key</label>
                        <select id="rootKey" class="w-full bg-zinc-900 border border-zinc-700 text-amber-500 focus:outline-none rounded-sm">
                            <option value="C">C</option>
                            <option value="C#">C#</option>
                            <option value="D">D</option>
                            <option value="D#">D#</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F#</option>
                            <option value="G">G</option>
                            <option value="G#">G#</option>
                            <option value="A">A</option>
                            <option value="A#">A#</option>
                            <option value="B">B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1">Reverb</label>
                        <select id="reverbAmt" class="w-full bg-zinc-900 border border-zinc-700 text-amber-500 focus:outline-none rounded-sm">
                            <option value="0">Dry</option>
                            <option value="0.2">Small Room</option>
                            <option value="0.5" selected>Concert Hall</option>
                            <option value="0.8">Cathedral</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block mb-1 flex justify-between"><span>Drone Vol</span> <span id="dv-val" class="text-white">30%</span></label>
                        <input type="range" id="droneVol" min="0" max="1" step="0.01" value="0.3" oninput="document.getElementById('dv-val').innerText = Math.round(this.value*100)+'%'; updateDroneVolume(this.value)">
                    </div>
                    <div>
                        <label class="block mb-1 flex justify-between"><span>Note Vol</span> <span id="nv-val" class="text-white">90%</span></label>
                        <input type="range" id="noteVol" min="0" max="1" step="0.01" value="0.9" oninput="document.getElementById('nv-val').innerText = Math.round(this.value*100)+'%'">
                    </div>
                </div>
            </div>

            <div class="control-group flex flex-col justify-between">
                <div class="mb-2">
                    <div class="flex justify-between mb-1 items-center">
                        <label>Duration (s)</label>
                        <input type="number" id="noteDurInput" value="2.5" step="0.1" min="0.1">
                    </div>
                    <input type="range" id="noteDuration" min="0.1" max="8" step="0.1" value="2.5">
                </div>

                <div class="mb-2">
                    <div class="flex justify-between mb-1 items-center">
                        <label>Gap (s)</label>
                        <input type="number" id="noteGapInput" value="1.0" step="0.1">
                    </div>
                    <input type="range" id="noteGap" min="-2" max="8" step="0.1" value="1.0">
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label>Octaves</label>
                        <span class="text-[10px] text-amber-500 font-bold"><span id="octaveMinDisplay">3</span>-<span id="octaveMaxDisplay">5</span></span>
                    </div>
                    <div class="range-slider-container">
                        <div class="absolute top-1/2 left-0 w-full h-0.5 bg-zinc-800 -translate-y-1/2 rounded"></div>
                        <div id="slider-track" class="absolute top-1/2 h-0.5 bg-amber-700/80 -translate-y-1/2 z-0"></div>
                        <input type="range" id="octaveMin" min="1" max="6" step="1" value="3">
                        <input type="range" id="octaveMax" min="1" max="6" step="1" value="5">
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group flex flex-col justify-center">
            <div class="flex justify-between items-center mb-3">
                <label class="text-zinc-500 font-bold">Active Degrees</label>
                <div class="space-x-2">
                    <button onclick="selectAllDegrees()" class="text-[9px] uppercase hover:text-white text-zinc-500">All</button>
                    <button onclick="selectDiatonic()" class="text-[9px] uppercase hover:text-white text-zinc-500">Major</button>
                    <button onclick="selectNone()" class="text-[9px] uppercase hover:text-white text-zinc-500">None</button>
                </div>
            </div>

            <div class="flex flex-col items-center gap-2 w-full select-none">
                <div id="chromaticLayer" class="flex justify-center gap-1 w-full flex-wrap"></div>
                <div id="diatonicLayer" class="flex justify-center gap-1 w-full flex-wrap"></div>
            </div>
        </div>

        <div class="flex flex-col items-center gap-3 mt-2">
            <button id="toggleBtn" class="w-full md:w-64 py-3 bg-zinc-800 text-zinc-500 font-bold text-sm uppercase tracking-widest transition-colors rounded-sm shadow-lg cursor-not-allowed">
                Initialize Audio
            </button>
            
            <div id="currentNoteDisplay" class="flex flex-col items-center opacity-0 transition-opacity duration-500 h-12 justify-center">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-zinc-600 text-[10px] uppercase tracking-widest">Current Note</span>
                    <button onclick="toggleBlindMode()" id="blindToggle" class="text-[9px] bg-zinc-900 px-2 py-0.5 rounded text-zinc-500 hover:text-white border border-zinc-800">Hide</button>
                </div>
                <div class="relative">
                    <div id="blindOverlay" class="hidden absolute inset-0 backdrop-blur-md bg-black/80 z-10 rounded"></div>
                    <span id="noteName" class="text-2xl font-bold text-white font-mono leading-none">--</span>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* --- CONSTANTS --- */
        const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        const SOLFEGE_MAP = {
            0: { num: "1", sol: "Do" }, 1: { num: "b2", sol: "Ra" }, 2: { num: "2", sol: "Re" },
            3: { num: "b3", sol: "Me" }, 4: { num: "3", sol: "Mi" }, 5: { num: "4", sol: "Fa" },
            6: { num: "b5", sol: "Se" }, 7: { num: "5", sol: "Sol" }, 8: { num: "b6", sol: "Le" },
            9: { num: "6", sol: "La" }, 10: { num: "b7", sol: "Te" }, 11: { num: "7", sol: "Ti" }
        };

        const DEGREES = [
            { semi: 0, type: 'dia', label: '1', sub: 'Do' },
            { semi: 1, type: 'chr', label: 'b2', sub: 'Ra' }, { semi: 2, type: 'dia', label: '2', sub: 'Re' },
            { semi: 3, type: 'chr', label: 'b3', sub: 'Me' }, { semi: 4, type: 'dia', label: '3', sub: 'Mi' },
            { semi: 5, type: 'dia', label: '4', sub: 'Fa' }, { semi: 6, type: 'chr', label: 'b5', sub: 'Se' },
            { semi: 7, type: 'dia', label: '5', sub: 'Sol' }, { semi: 8, type: 'chr', label: 'b6', sub: 'Le' },
            { semi: 9, type: 'dia', label: '6', sub: 'La' }, { semi: 10, type: 'chr', label: 'b7', sub: 'Te' },
            { semi: 11, type: 'dia', label: '7', sub: 'Ti' },
        ];

        // Using Salamander Grand Piano samples (lighter selection to save bandwidth)
        const SAMPLES_URL_PREFIX = "https://gleitz.github.io/midi-js-soundfonts/SalamanderGrandPiano/";
        // We load every 3rd or 4th note and pitch-shift to fill gaps
        const SAMPLE_MAP = {
            "A0": "A0.mp3", "C1": "C1.mp3", "D#1": "D#1.mp3", "F#1": "F#1.mp3", "A1": "A1.mp3",
            "C2": "C2.mp3", "D#2": "D#2.mp3", "F#2": "F#2.mp3", "A2": "A2.mp3",
            "C3": "C3.mp3", "D#3": "D#3.mp3", "F#3": "F#3.mp3", "A3": "A3.mp3",
            "C4": "C4.mp3", "D#4": "D#4.mp3", "F#4": "F#4.mp3", "A4": "A4.mp3",
            "C5": "C5.mp3", "D#5": "D#5.mp3", "F#5": "F#5.mp3", "A5": "A5.mp3",
            "C6": "C6.mp3", "D#6": "D#6.mp3", "F#6": "F#6.mp3", "A6": "A6.mp3",
            "C7": "C7.mp3", "D#7": "D#7.mp3", "F#7": "F#7.mp3", "A7": "A7.mp3",
            "C8": "C8.mp3"
        };

        /* --- STATE --- */
        let audioCtx;
        let masterGain;
        let reverbNode;
        let compressor;
        let pianoBuffers = {};
        let droneGain = null; 
        let droneNodes = [];
        
        let isPlaying = false;
        let samplesLoaded = false;
        
        let nextNoteTime = 0;
        let schedulerTimer = null;
        let activeDegrees = new Set([0, 2, 4, 5, 7, 9, 11]); 
        let blindMode = false;

        /* --- UI LOGIC --- */
        const btnToggle = document.getElementById('toggleBtn');
        
        function initUI() {
            renderGrid();
            bindInputs();
            updateSliderTrack();
        }

        function renderGrid() {
            const dia = document.getElementById('diatonicLayer');
            const chr = document.getElementById('chromaticLayer');
            dia.innerHTML = ''; chr.innerHTML = '';
            
            DEGREES.forEach(d => {
                const btn = document.createElement('div');
                btn.innerHTML = `<span class="main-lbl">${d.label}</span><span class="sub-lbl">${d.sub}</span>`;
                btn.className = `degree-sq ${activeDegrees.has(d.semi) ? 'active' : ''}`;
                btn.onclick = () => {
                    if (activeDegrees.has(d.semi)) {
                        activeDegrees.delete(d.semi);
                        btn.classList.remove('active');
                    } else {
                        activeDegrees.add(d.semi);
                        btn.classList.add('active');
                    }
                };
                (d.type === 'dia' ? dia : chr).appendChild(btn);
            });
        }

        function bindInputs() {
            const durS = document.getElementById('noteDuration');
            const durI = document.getElementById('noteDurInput');
            const gapS = document.getElementById('noteGap');
            const gapI = document.getElementById('noteGapInput');
            
            durS.oninput = (e) => durI.value = e.target.value;
            durI.onchange = (e) => { durS.value = e.target.value; };
            gapS.oninput = (e) => gapI.value = e.target.value;
            gapI.onchange = (e) => { gapS.value = e.target.value; };
            
            document.getElementById('octaveMin').oninput = validateOctave;
            document.getElementById('octaveMax').oninput = validateOctave;
            
            document.getElementById('reverbAmt').onchange = (e) => {
                 if(reverbNode) {
                    // Just regenerate reverb on change for simplicity
                    createReverbImpulse(parseFloat(e.target.value));
                 }
            };
        }

        function validateOctave(e) {
            const minEl = document.getElementById('octaveMin');
            const maxEl = document.getElementById('octaveMax');
            let min = parseInt(minEl.value);
            let max = parseInt(maxEl.value);
            
            if (e.target.id === 'octaveMin' && min > max) minEl.value = max;
            if (e.target.id === 'octaveMax' && max < min) maxEl.value = min;
            
            document.getElementById('octaveMinDisplay').innerText = minEl.value;
            document.getElementById('octaveMaxDisplay').innerText = maxEl.value;
            updateSliderTrack();
        }

        function updateSliderTrack() {
            const minEl = document.getElementById('octaveMin');
            const maxEl = document.getElementById('octaveMax');
            const min = parseInt(minEl.value);
            const max = parseInt(maxEl.value);
            const range = parseInt(minEl.max) - parseInt(minEl.min);
            const left = ((min - 1) / range) * 100;
            const width = range === 0 ? 5 : ((max - min) / range) * 100; // Min width 5%
            
            const track = document.getElementById('slider-track');
            track.style.left = left + "%";
            track.style.width = width + "%";
        }

        function toggleBlindMode() {
            blindMode = !blindMode;
            const ov = document.getElementById('blindOverlay');
            const btn = document.getElementById('blindToggle');
            if (blindMode) {
                ov.classList.remove('hidden');
                btn.classList.add('text-amber-500', 'border-amber-500');
                btn.innerText = "Show";
            } else {
                ov.classList.add('hidden');
                btn.classList.remove('text-amber-500', 'border-amber-500');
                btn.innerText = "Hide";
            }
        }

        function selectAllDegrees() { activeDegrees = new Set(DEGREES.map(d=>d.semi)); renderGrid(); }
        function selectDiatonic() { activeDegrees = new Set([0,2,4,5,7,9,11]); renderGrid(); }
        function selectNone() { activeDegrees = new Set([]); renderGrid(); }


        /* --- AUDIO ENGINE: SAMPLER --- */
        
        async function initAudioAndLoad() {
            if (audioCtx) return; // Already init
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Master Chain: Reverb -> Compressor -> Master
            masterGain = audioCtx.createGain();
            compressor = audioCtx.createDynamicsCompressor();
            reverbNode = audioCtx.createConvolver();

            // Setup Compressor (Safety & Glue)
            compressor.threshold.value = -20;
            compressor.ratio.value = 12;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.25;
            
            // Generate initial Reverb
            createReverbImpulse(0.5); // Default Concert Hall

            // Route: Sources -> Reverb -> Master -> Compressor -> Out
            // Dry signal will also go straight to Master
            reverbNode.connect(masterGain);
            masterGain.connect(compressor);
            compressor.connect(audioCtx.destination);

            // Load Samples
            document.getElementById('loader-container').classList.remove('hidden');
            document.getElementById('loader-text').classList.remove('hidden');
            btnToggle.innerText = "Loading...";
            
            await loadSamples();
            
            samplesLoaded = true;
            document.getElementById('loader-container').classList.add('hidden');
            document.getElementById('loader-text').classList.add('hidden');
            
            btnToggle.classList.remove('bg-zinc-800', 'text-zinc-500', 'cursor-not-allowed');
            btnToggle.classList.add('bg-amber-500', 'text-black', 'hover:bg-amber-400');
            btnToggle.innerText = "Start Training";
        }

        async function loadSamples() {
            const promises = [];
            const notes = Object.keys(SAMPLE_MAP);
            const total = notes.length;
            let loaded = 0;

            for (const note of notes) {
                const url = SAMPLES_URL_PREFIX + SAMPLE_MAP[note];
                promises.push(
                    fetch(url)
                        .then(response => response.arrayBuffer())
                        .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
                        .then(audioBuffer => {
                            pianoBuffers[note] = audioBuffer;
                            loaded++;
                            document.getElementById('loader-bar').style.width = (loaded / total * 100) + '%';
                        })
                        .catch(e => console.error("Failed to load " + note, e))
                );
            }
            await Promise.all(promises);
        }

        // Create a synthetic Impulse Response for Reverb (saves loading another file)
        function createReverbImpulse(duration) {
            if (duration === 0) {
                // disconnect reverb logic handled in play function via mix
                return;
            }
            const rate = audioCtx.sampleRate;
            const length = rate * duration;
            const impulse = audioCtx.createBuffer(2, length, rate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);

            for (let i = 0; i < length; i++) {
                // Exponential decay noise
                const n = i < length * 0.02 ? 0 : Math.random() * 2 - 1; // Pre-delay silence
                const decay = Math.pow(1 - i / length, 3);
                left[i] = n * decay;
                right[i] = n * decay;
            }
            reverbNode.buffer = impulse;
        }

        function noteToMidi(noteName) {
            // e.g. "C4" -> 60
            const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            const octave = parseInt(noteName.slice(-1));
            const key = noteName.slice(0, -1);
            return notes.indexOf(key) + (octave + 1) * 12;
        }

        function getNearestSample(midi) {
            // Find closest loaded sample
            let minDist = Infinity;
            let bestNote = null;
            
            for (const noteName of Object.keys(pianoBuffers)) {
                const smidi = noteToMidi(noteName);
                const dist = Math.abs(midi - smidi);
                if (dist < minDist) {
                    minDist = dist;
                    bestNote = noteName;
                }
            }
            return { buffer: pianoBuffers[bestNote], centerMidi: noteToMidi(bestNote) };
        }

        function playSample(midi, time, duration, velocity = 1.0) {
            const match = getNearestSample(midi);
            if (!match.buffer) return;

            const source = audioCtx.createBufferSource();
            source.buffer = match.buffer;

            // Pitch shift
            const semitones = midi - match.centerMidi;
            const detune = semitones * 100; 
            source.detune.value = detune;

            // Velocity/Volume Gain
            const gainNode = audioCtx.createGain();
            
            // Mix Dry/Wet
            const reverbAmt = parseFloat(document.getElementById('reverbAmt').value);
            const dryGain = audioCtx.createGain();
            const wetGain = audioCtx.createGain();

            dryGain.gain.value = (1 - reverbAmt * 0.4); // Keep dry distinct
            wetGain.gain.value = reverbAmt;

            source.connect(gainNode);
            gainNode.connect(dryGain);
            gainNode.connect(wetGain);
            
            dryGain.connect(masterGain);
            wetGain.connect(reverbNode);

            // Envelope (Samples already have decay, but we enforce duration)
            const vol = parseFloat(document.getElementById('noteVol').value) * velocity;
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(vol, time + 0.02); // Quick attack
            
            // Release
            gainNode.gain.setValueAtTime(vol, time + duration - 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration + 0.5);

            source.start(time);
            source.stop(time + duration + 1.0); // Allow tail
        }

        /* --- DRONE (Simplified for Ambience) --- */
        function startDrone() {
            const rootName = document.getElementById('rootKey').value;
            const rootIdx = NOTE_NAMES.indexOf(rootName.replace(/\d/, ''));
            const freq = 440 * Math.pow(2, ((rootIdx + 36) - 69) / 12); // Low C2 range

            droneGain = audioCtx.createGain();
            droneGain.connect(masterGain);
            updateDroneVolume(document.getElementById('droneVol').value); 

            // Use 2 oscillators for a warm pad
            const createOsc = (detune) => {
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth'; // Richer harmonics
                osc.frequency.value = freq;
                osc.detune.value = detune;
                
                // Lowpass filter to make it a dark pad, not a buzz
                const lpf = audioCtx.createBiquadFilter();
                lpf.type = 'lowpass';
                lpf.frequency.value = 150; // Very muffled
                
                osc.connect(lpf);
                lpf.connect(droneGain);
                osc.start();
                droneNodes.push(osc);
            };

            createOsc(-5);
            createOsc(5);
            droneNodes.push(droneGain);
        }

        function updateDroneVolume(val) {
            if(droneGain) {
                droneGain.gain.cancelScheduledValues(audioCtx.currentTime);
                // Drone is inherently loud, so we scale it down
                droneGain.gain.linearRampToValueAtTime(parseFloat(val) * 0.2, audioCtx.currentTime + 0.1);
            }
        }

        function stopDrone() {
            if(droneGain) droneGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
            setTimeout(() => {
                droneNodes.forEach(n => n.stop ? n.stop() : n.disconnect());
                droneNodes = [];
                droneGain = null;
            }, 1100);
        }

        /* --- SCHEDULER LOGIC --- */
        
        function performCadenceAndStart() {
            const t = audioCtx.currentTime + 0.1;
            const rootName = document.getElementById('rootKey').value;
            const rootIdx = NOTE_NAMES.indexOf(rootName.replace(/\d/, ''));
            
            // Root - Dominant - Root cadence
            const midiRoot = rootIdx + 48; // C3 range
            const midiDom = rootIdx + 55;  // G3

            // Play chords (Root-5-Octave)
            const playChord = (baseMidi, time) => {
                 playSample(baseMidi, time, 2.0, 0.6);
                 playSample(baseMidi + 7, time, 2.0, 0.5);
                 playSample(baseMidi + 12, time, 2.0, 0.5);
            };

            playChord(midiRoot, t);
            playChord(midiDom, t + 1.5);
            playChord(midiRoot, t + 3.0);

            nextNoteTime = t + 4.5; 
            runScheduler();
        }

        function runScheduler() {
            if(isPlaying) {
                while(nextNoteTime < audioCtx.currentTime + 0.1) {
                    scheduleNote();
                }
                schedulerTimer = setTimeout(runScheduler, 25);
            }
        }

        function scheduleNote() {
            const degrees = Array.from(activeDegrees);
            if (degrees.length === 0) { nextNoteTime += 1; return; }
            
            const semitone = degrees[Math.floor(Math.random() * degrees.length)];
            const minOct = parseInt(document.getElementById('octaveMin').value);
            const maxOct = parseInt(document.getElementById('octaveMax').value);
            const octave = Math.floor(Math.random() * (maxOct - minOct + 1)) + minOct;

            const rootName = document.getElementById('rootKey').value;
            const rootIdx = NOTE_NAMES.indexOf(rootName.replace(/\d/, ''));
            
            let noteIdx = rootIdx + semitone;
            let actualOctave = octave;
            if (noteIdx > 11) { noteIdx %= 12; actualOctave++; }
            
            // Calculate MIDI
            const midi = noteIdx + (actualOctave + 1) * 12;

            const dur = parseFloat(document.getElementById('noteDurInput').value);
            const gap = parseFloat(document.getElementById('noteGapInput').value);

            playSample(midi, nextNoteTime, dur);

            // UI Update
            const visualTime = (nextNoteTime - audioCtx.currentTime) * 1000;
            const solfegeInfo = SOLFEGE_MAP[semitone];
            setTimeout(() => {
                if(!isPlaying) return;
                document.getElementById('currentNoteDisplay').style.opacity = 1;
                document.getElementById('noteName').innerText = `${solfegeInfo.num} (${solfegeInfo.sol})`;
            }, visualTime);

            nextNoteTime += (dur + gap);
        }

        /* --- INITIALIZATION HANDLER --- */
        btnToggle.addEventListener('click', () => {
            if(!samplesLoaded) {
                // First click: Initialize Audio Context and Load
                initAudioAndLoad();
                return;
            }

            if (isPlaying) {
                isPlaying = false;
                clearTimeout(schedulerTimer);
                stopDrone();
                btnToggle.innerText = "Start Training";
                btnToggle.classList.replace('bg-red-500', 'bg-amber-500');
                btnToggle.classList.replace('hover:bg-red-400', 'hover:bg-amber-400');
                document.getElementById('status-display').style.opacity = 0;
                document.getElementById('currentNoteDisplay').style.opacity = 0;
            } else {
                if(activeDegrees.size === 0) return alert("Select at least one degree!");
                if(audioCtx.state === 'suspended') audioCtx.resume();
                
                isPlaying = true;
                startDrone();
                performCadenceAndStart();
                btnToggle.innerText = "Stop Session";
                btnToggle.classList.replace('bg-amber-500', 'bg-red-500');
                btnToggle.classList.replace('hover:bg-amber-400', 'hover:bg-red-400');
                document.getElementById('status-display').style.opacity = 1;
            }
        });

        initUI();
    </script>
</body>
</html>